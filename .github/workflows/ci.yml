name: Basic CI

on:
  push:
  workflow_dispatch:

env:
  # Use docker.io for Docker Hub if empty
  REGISTRY: ghcr.io
  # github.repository as <account>/<repo>
  IMAGE_NAME: ${{ github.repository }}
  SMOKE_IMAGE: logicle-smoke:${{ github.sha }}

jobs:
  docker:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,format=long

      - name: Build image for smoke test
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          tags: ${{ env.SMOKE_IMAGE }}
          cache-from: type=gha,scope=nextjs-build
          cache-to: type=gha,mode=max,scope=nextjs-build

      - name: Run container smoke test
        run: |
          set -euo pipefail

          docker run -d \
            --name logicle-smoke \
            -p 3000:3000 \
            -e APP_URL=http://localhost:3000 \
            -e DATABASE_URL=file:///data/sqlite/logicle.sqlite \
            -e FILE_STORAGE_LOCATION=/data/files \
            "${SMOKE_IMAGE}"

          echo "Waiting for app startup..."
          ready=0
          for i in $(seq 1 60); do
            if curl -fsS http://localhost:3000/api/health >/dev/null; then
              ready=1
              break
            fi
            sleep 1
          done

          if [ "${ready}" -ne 1 ]; then
            echo "Smoke test failed: app did not become ready within 60 seconds"
            docker logs logicle-smoke || true
            exit 1
          fi

          bash .github/scripts/ci-smoke.sh "http://localhost:3000"

      - name: Stop smoke container
        if: always()
        run: |
          docker rm -f logicle-smoke || true

      - name: Login to GitHub Container Registry
        if: github.event_name == 'workflow_dispatch'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push image tags (workflow dispatch only)
        if: github.event_name == 'workflow_dispatch'
        run: |
          set -euo pipefail
          echo "${{ steps.meta.outputs.tags }}" | while IFS= read -r tag; do
            if [ -n "${tag}" ]; then
              docker tag "${SMOKE_IMAGE}" "${tag}"
              docker push "${tag}"
            fi
          done
